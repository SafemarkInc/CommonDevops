parameters:
- name: buildProjectPath
  type: string
- name: testProjectPath
  type: string
  default: null
- name: terraformPath
  type: string
- name: terraformMainResource
  type: string
- name: terraformWebappName
  type: string

steps:
- task: UseDotNet@2 
  displayName: ".NET Core 6.0.x"
  inputs:
    version: '6.0.x'
  
- task: DotNetCoreCLI@2
  condition: ne('${{ parameters.testProjectPath }}', '')
  displayName: dotnet test
  inputs:
    command: test
    projects: '$(Env:SYSTEM_TEAMPROJECT)\$(testProjectPath)'

- task: DotNetCoreCLI@2
  displayName: dotnet publish
  inputs:
    command: publish
    projects: '$(Env:SYSTEM_TEAMPROJECT)\$(buildProjectPath)'
    publishWebProjects: True
    arguments: '--configuration Release --output Publish'
    zipAfterPublish: True

- powershell: |
    pwd
    dir env:
    New-Item -Name deploy -ItemType "Directory"
    $DeployScript = Get-Content .\CommonDevops\deploy.ps1
    $DeployScript = ,('$BuildNumber = "' + $Env:BUILD_BUILDNUMBER + '"') + $DeployScript
    $DeployScript = ,('$BuildDate = "' + (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss") + '"') + $DeployScript
    $DeployScript = ,('$MainResourceName = "${{ parameters.terraformMainResource }}"') + $DeployScript
    $DeployScript = ,('$WebappName = "${{ parameters.terraformWebappName }}"') + $DeployScript
    $DeployScript | Out-File ./deploy/deploy.ps1
    Copy-Item -Path "${Env:SYSTEM_TEAMPROJECT}\${{ parameters.terraformPath }}" -Destination "./deploy" -Recurse -Verbose
    New-Item "./deploy/CommonDevops" -ItemType Directory
    Copy-Item -Path "./CommonDevops/US" -Destination "./deploy/CommonDevops" -Recurse -Verbose
    Copy-Item -Path "./CommonDevops/Korea" -Destination "./deploy/CommonDevops" -Recurse -Verbose
    Copy-Item "./CommonDevops/_terraform_init.ps1" -Destination "./deploy/CommonDevops"
    Copy-Item "./CommonDevops/common.tf" -Destination "./deploy/CommonDevops"
    Copy-Item -Path "Publish/*" -Destination "./deploy"
  displayName: Assemble the deployment package
  
- publish: ./deploy
  displayName: Publish artifact
  artifact: deploy
