parameters:
- name: buildProjectPath
  type: string
- name: testProjectPath
  type: string
  default: ''
- name: terraformPath
  type: string
- name: terraformMainResource
  type: string
- name: terraformWebappName
  type: string

steps:
- task: UseDotNet@2 
  displayName: ".NET Core 6.0.x"
  inputs:
    version: '6.0.x'

- script: dotnet test "%SYSTEM_TEAMPROJECT%\${{ parameters.testProjectPath }}"
  condition: ne('${{ parameters.testProjectPath }}', '')
  displayName: dotnet test

#- task: DotNetCoreCLI@2
#  displayName: dotnet publish
#  inputs:
#    command: publish
#    projects: '$(Env:SYSTEM_TEAMPROJECT)\${{ parameters.buildProjectPath }}'
#    publishWebProjects: True
#    arguments: '--configuration Release --output Publish'
#    zipAfterPublish: True

# Run this after the publish step so that the additional package doesn't add weight to the publish.
# TODO: Make this step optional
# TODO: Make the project configurable
# TODO: Pull version 6.0.12 out into a variable
- script: |
    pwd
    ls -R
    dotnet add ./SafemarkIdentity/SafemarkIdentity.csproj package Microsoft.EntityFrameworkCore.Design --version 6.0.12
    dotnet tool install --global dotnet-ef --version 6.0.12
    dotnet ef migrations script --project ./SafemarkIdentity/SafemarkIdentity --idempotent --output ./deploy/upgrade_schema.sql
    cat ./deploy/upgrade_schema.sql
  displayName: Generate SQL upgrade script

- powershell: |
    $ProjectDir = ${Env:BUILD_REPOSITORY_NAME}.Split("/")[1]
    New-Item -Name deploy -ItemType "Directory"
    $DeployScript = Get-Content .\CommonDevops\deploy.ps1
    $DeployScript = ,('$BuildNumber = "' + $Env:BUILD_BUILDNUMBER + '"') + $DeployScript
    $DeployScript = ,('$BuildDate = "' + (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss") + '"') + $DeployScript
    $DeployScript = ,('$MainResourceName = "${{ parameters.terraformMainResource }}"') + $DeployScript
    $DeployScript = ,('$WebappName = "${{ parameters.terraformWebappName }}"') + $DeployScript
    $DeployScript | Out-File ./deploy/deploy.ps1
    Copy-Item -Path "$ProjectDir\${{ parameters.terraformPath }}" -Destination "./deploy" -Recurse -Verbose
    New-Item "./deploy/CommonDevops" -ItemType Directory
    Copy-Item -Path "./CommonDevops/US" -Destination "./deploy/CommonDevops" -Recurse -Verbose
    Copy-Item -Path "./CommonDevops/China" -Destination "./deploy/CommonDevops" -Recurse -Verbose
    Copy-Item -Path "./CommonDevops/Korea" -Destination "./deploy/CommonDevops" -Recurse -Verbose
    Copy-Item "./CommonDevops/_terraform_init.ps1" -Destination "./deploy/CommonDevops"
    Copy-Item "./CommonDevops/common.tf" -Destination "./deploy/CommonDevops"
    Copy-Item -Path "Publish/*" -Destination "./deploy"
  displayName: Assemble the deployment package
  
- publish: ./deploy
  displayName: Publish artifact
  artifact: deploy
